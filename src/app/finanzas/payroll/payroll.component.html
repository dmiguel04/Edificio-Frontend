<div class="payroll-root">
  <div class="page-header">
    <h2>Nómina</h2>
    <div class="header-actions">
      <button class="btn" routerLink="/finanzas/treasury">Ir a Gestión Financiera</button>
    </div>
  </div>

  <div class="card grid">
  <section class="create" style="min-width:420px;">
      <h4>Crear ciclo de nómina</h4>
      <form class="form" (ngSubmit)="createPayroll()">
        <div class="fields">
          <label>Nombre</label>
          <input type="text" [(ngModel)]="name" name="name" placeholder="Nombre del ciclo" />

          <label>Periodo inicio</label>
          <input type="date" [(ngModel)]="period_start" name="period_start" />

          <label>Periodo fin</label>
          <input type="date" [(ngModel)]="period_end" name="period_end" />

          <label>Cargo</label>
          <input type="text" [(ngModel)]="cargo" name="cargo" placeholder="Conserje, Portero..." />

          <label>Total (unidades)</label>
          <input type="number" step="0.01" [(ngModel)]="total_amount" name="total_amount" min="0" placeholder="Ej: 34344.34" />
          <div style="margin-top:6px">
            <button type="button" class="btn" (click)="toggleDetails()" aria-expanded="{{showDetails}}">{{ showDetails ? 'Ocultar campos' : 'Más campos' }}</button>
            <button type="button" class="btn" (click)="addEntry()" style="margin-left:6px">Añadir concepto</button>
            <button type="button" class="btn" (click)="fillSample()" style="margin-left:6px">Rellenar ejemplo</button>
            <button type="button" class="btn" (click)="resetForm()" style="margin-left:6px">Limpiar</button>
          </div>
        </div>

  <div class="payroll-form" [hidden]="!showDetails" style="max-height:none; overflow:visible;">
          <div *ngIf="successMessage" class="alert success">{{ successMessage }}</div>
          <div *ngIf="errorMessage" class="alert error">{{ errorMessage }}</div>
          <h4>Conceptos</h4>
          <table class="entries-table">
            <thead>
              <tr>
                <th>Tipo</th><th>Descripción</th><th>Días</th><th>Total (unidades)</th><th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let e of entries; let i = index; trackBy: trackByEntry">
                <td>
                  <select [(ngModel)]="entries[i].type" name="type-{{i}}">
                    <option value="earning">Sueldo / Devengado</option>
                    <option value="deduction">Deducción</option>
                  </select>
                </td>
                <td><input [(ngModel)]="entries[i].description" name="desc-{{i}}" /></td>
                <td><input type="number" [(ngModel)]="entries[i].days" name="days-{{i}}" /></td>
                <td><input type="number" step="0.01" [(ngModel)]="entries[i].amount" name="amount-{{i}}" /></td>
                <td><button type="button" (click)="removeEntry(i)">Eliminar</button></td>
              </tr>
            </tbody>
          </table>
          <div style="margin-top:8px;">
            <button type="button" (click)="addEntry()">Añadir concepto</button>
          </div>
        </div>

        <div class="summary" style="margin-top:12px">
          <h4>Resumen</h4>
          <div>Devengados: {{ computeTotalsUnits().gross | number:'1.2-2' }}</div>
          <div>Deducciones: {{ computeTotalsUnits().deductions | number:'1.2-2' }}</div>
          <div><strong>Neto: {{ computeTotalsUnits().net | number:'1.2-2' }}</strong></div>
        </div>

        <div class="actions">
          <button class="btn primary" type="submit" [disabled]="loading">{{ loading ? 'Creando...' : 'Crear' }}</button>
        </div>
      </form>
    </section>

    <section class="list">
      <h4>Listado</h4>
      <div *ngIf="loading" class="muted">Cargando...</div>

      <div *ngIf="!loading && payrolls.length" class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Periodo</th>
              <th class="amount-col">Total</th>
              <th class="actions-col">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of payrolls" title="{{p.name}}">
              <td class="id">{{ p.id }}</td>
              <td class="name">{{ p.name }}</td>
              <td class="period">{{ p.period_start | date:'shortDate' }} - {{ p.period_end | date:'shortDate' }}</td>
              <td class="amount-col">{{ (p.total_amount/100) | currency:(p.currency ? (p.currency | uppercase) : 'USD') }}</td>
              <td class="actions-col">
                <div class="row-actions">
                  <button class="icon-button" title="Descargar" (click)="downloadPayroll(p.id)">
                    <!-- download icon -->
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10" stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11l4 4 4-4" stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21H3" stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                  <button class="icon-button primary" title="Pagar nómina" (click)="payPayroll(p.id)">
                    <!-- pay icon -->
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 12h14" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="!loading && !payrolls.length" class="muted">No hay ciclos</div>
    </section>
  </div>
</div>
